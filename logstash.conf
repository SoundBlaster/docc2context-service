input {
  # Accept JSON logs from application on stdin (via docker logs)
  stdin {
    codec => json
    type => "application"
  }
}

filter {
  # Parse JSON logs from FastAPI application
  if [type] == "application" {
    # Extract timestamp if ISO8601 format
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }

    # Tag error logs for filtering
    if [level] == "ERROR" or [level] == "CRITICAL" {
      mutate {
        add_tag => [ "error", "alert_candidate" ]
      }
    }

    # Tag extraction events
    if [event_type] == "extraction" {
      mutate {
        add_tag => [ "extraction" ]
      }
      if [status] == "failure" {
        mutate {
          add_tag => [ "failure" ]
        }
      }
    }

    # Tag security events
    if [event_type] == "auth_failure" {
      mutate {
        add_tag => [ "security", "auth_failure" ]
      }
    }

    if [event_type] == "rate_limit" {
      mutate {
        add_tag => [ "security", "rate_limit" ]
      }
    }

    # Tag performance anomalies
    if [event_type] == "performance_anomaly" {
      mutate {
        add_tag => [ "performance", "anomaly" ]
      }
    }

    # GeoIP enrichment for client IPs (optional)
    if [client_ip] and [client_ip] != "-" and ![geoip] {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }

    # Ensure timestamp exists
    if ![timestamp] and ![@timestamp] {
      mutate {
        add_field => { "timestamp" => "%{@timestamp}" }
      }
    }
  }
}

output {
  # Send all logs to Elasticsearch with daily index rotation
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "docc2context-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Also output to stdout for Docker logs visibility (development)
  stdout {
    codec => rubydebug
  }
}
