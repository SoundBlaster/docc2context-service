# Task 5.1 Implementation PRD — Disable Swagger and Configure CORS

**Status:** READY FOR EXECUTION
**Priority:** Critical (Blocking Production)
**Effort:** 1-2 hours
**Phase:** 5 (Production Security)

---

## Overview

Disable Swagger/OpenAPI documentation endpoints in production and restrict CORS to specific origins instead of `["*"]`. These are information disclosure vulnerabilities (CVE-DOCC-2024-006 and CVE-DOCC-2024-007 equivalents) that must be fixed before production deployment.

---

## Current State Analysis

### Configuration (app/core/config.py)
- ✅ `environment` setting exists (values: development, staging, production)
- ❌ No `SWAGGER_ENABLED` setting
- ❌ `cors_origins` defaults to `["*"]` (insecure)
- ❌ No ability to override via environment

### FastAPI Setup (app/main.py)
- ❌ Swagger/docs always enabled (accessible at `/docs`, `/redoc`, `/openapi.json`)
- ❌ CORS always allows all origins
- ✅ Security middleware present
- ✅ HTTPS redirect for production

---

## Implementation Checklist

### Subtask 1: Add Configuration Settings
**File:** `app/core/config.py`

- [ ] Add `swagger_enabled: bool = True` (default enabled for dev)
- [ ] Update CORS setting from `cors_origins: list[str] = ["*"]` to properly parse from env
- [ ] Add validation: if `environment == "production"`, enforce `swagger_enabled == False`
- [ ] Add validation: if `swagger_enabled == False`, require explicit CORS origins (reject `["*"]`)

**Verification:**
```bash
# Test default (development)
python -c "from app.core.config import settings; print(f'Swagger: {settings.swagger_enabled}, CORS: {settings.cors_origins}')"

# Test production with env var
ENVIRONMENT=production SWAGGER_ENABLED=false CORS_ORIGINS='["https://yourdomain.com"]' python -c "from app.core.config import settings; print(f'Swagger: {settings.swagger_enabled}, CORS: {settings.cors_origins}')"
```

**Acceptance Criteria:**
- [ ] `swagger_enabled` defaults to `True` in development
- [ ] `cors_origins` can be set via environment variable
- [ ] Production with `swagger_enabled=false` is enforced if `environment=production`
- [ ] Validation fails if Swagger disabled but CORS is `["*"]`

---

### Subtask 2: Conditionally Disable Swagger in FastAPI
**File:** `app/main.py`

- [ ] Modify FastAPI instantiation to conditionally include docs
  - Option A: Use `docs_url=None, redoc_url=None, openapi_url=None` when `swagger_enabled=False`
  - Option B: Keep full setup, add middleware to block `/docs` routes
  - **Recommend Option A** — cleaner, prevents docs generation entirely
- [ ] Update line 19-21 from:
  ```python
  app = FastAPI(
      title=settings.app_name, description=settings.app_description, version=settings.app_version
  )
  ```
  To:
  ```python
  app = FastAPI(
      title=settings.app_name,
      description=settings.app_description,
      version=settings.app_version,
      docs_url="/docs" if settings.swagger_enabled else None,
      redoc_url="/redoc" if settings.swagger_enabled else None,
      openapi_url="/openapi.json" if settings.swagger_enabled else None,
  )
  ```

**Verification:**
```bash
# Development (Swagger enabled)
curl http://localhost:8000/docs  # Should return 200 with HTML

# Production (Swagger disabled)
SWAGGER_ENABLED=false python -m uvicorn app.main:app
curl http://localhost:8000/docs  # Should return 404
```

**Acceptance Criteria:**
- [ ] `/docs` returns 200 in development
- [ ] `/docs` returns 404 in production (when `SWAGGER_ENABLED=false`)
- [ ] `/redoc` returns 404 in production
- [ ] `/openapi.json` returns 404 in production
- [ ] Swagger JS not loaded (no network requests to `/openapi.json`)

---

### Subtask 3: Test CORS Configuration
**File:** `app/main.py` (lines 27-33)

Current code uses `settings.cors_origins`, which is already connected. Now ensure it works with environment variables.

- [ ] Test with `CORS_ORIGINS='["https://yourdomain.com"]'`
- [ ] Test with `CORS_ORIGINS='["https://yourdomain.com", "https://api.yourdomain.com"]'` (multiple origins)
- [ ] Verify unauthorized origin receives 403

**Verification Commands:**
```bash
# Set production config
export ENVIRONMENT=production
export SWAGGER_ENABLED=false
export CORS_ORIGINS='["https://yourdomain.com"]'
python -m uvicorn app.main:app

# Test allowed origin
curl -H "Origin: https://yourdomain.com" -H "Access-Control-Request-Method: POST" \
  http://localhost:8000/api/v1/convert
# Should have Access-Control-Allow-Origin header

# Test unauthorized origin
curl -H "Origin: https://evil.com" -H "Access-Control-Request-Method: POST" \
  http://localhost:8000/api/v1/convert
# Should NOT have Access-Control-Allow-Origin header or return 403
```

**Acceptance Criteria:**
- [ ] Allowed origin receives `Access-Control-Allow-Origin` header
- [ ] Unauthorized origin does NOT receive `Access-Control-Allow-Origin` header
- [ ] Production config works without `["*"]`

---

### Subtask 4: Create `.env.production` Example File
**File:** `.env.production` (new file)

```env
# Production Environment Configuration

# Application
ENVIRONMENT=production
API_HOST=0.0.0.0
API_PORT=8000

# Security - CRITICAL
SWAGGER_ENABLED=false
CORS_ORIGINS=["https://yourdomain.com"]
ALLOWED_HOSTS=["yourdomain.com", "api.yourdomain.com"]

# Logging
LOG_LEVEL=INFO

# File Upload
MAX_UPLOAD_SIZE_MB=100
MAX_DECOMPRESSED_SIZE_MB=500
MAX_ZIP_FILES=5000
MAX_ZIP_DEPTH=10

# Workspace
WORKSPACE_BASE_PATH=/tmp
WORKSPACE_PREFIX=swift-conv
WORKSPACE_PERMISSIONS=0o700
WORKSPACE_MAX_AGE_SECONDS=3600

# Subprocess
SWIFT_CLI_PATH=/usr/local/bin/docc2context
SUBPROCESS_TIMEOUT=60
MAX_SUBPROCESS_RETRIES=3
SUBPROCESS_MEMORY_LIMIT_MB=1024

# Rate Limiting
RATE_LIMIT=100

# Application Metadata
APP_NAME=DocC2Context Service
APP_VERSION=0.1.0
APP_DESCRIPTION=Swift DocC to Markdown Web Converter (MVP)
```

- [ ] Create file with all required environment variables
- [ ] Add comments explaining each setting
- [ ] Highlight security-critical settings (SWAGGER_ENABLED, CORS_ORIGINS, ALLOWED_HOSTS)
- [ ] Add instructions to copy to `.env` and customize

**Verification:**
```bash
cp .env.production .env.production.example
grep -c "SWAGGER_ENABLED\|CORS_ORIGINS\|ALLOWED_HOSTS" .env.production
# Should output: 3
```

**Acceptance Criteria:**
- [ ] `.env.production` file exists
- [ ] All required environment variables documented
- [ ] Security settings marked clearly
- [ ] Follows same format as current config
- [ ] Can be used as template for deployment

---

### Subtask 5: Update Environment Variable Parsing
**File:** `app/core/config.py`

Currently `cors_origins` is a Python list. Need to support JSON string from environment:

- [ ] Parse `CORS_ORIGINS` as JSON string: `'["https://yourdomain.com"]'`
- [ ] Handle comma-separated list fallback: `CORS_ORIGINS=https://yourdomain.com,https://api.yourdomain.com`
- [ ] Validate that `cors_origins` is never `["*"]` when in production mode
- [ ] Add `swagger_enabled` with environment variable support

**Implementation detail:**
```python
from pydantic import field_validator

class Settings(BaseSettings):
    cors_origins: list[str] = ["*"]
    swagger_enabled: bool = True

    @field_validator('cors_origins', mode='before')
    @classmethod
    def parse_cors_origins(cls, v):
        if isinstance(v, str):
            if v.startswith('['):  # JSON array
                import json
                return json.loads(v)
            else:  # Comma-separated
                return [origin.strip() for origin in v.split(',')]
        return v

    @field_validator('swagger_enabled', 'cors_origins', mode='after')
    @classmethod
    def validate_production_security(self):
        if self.environment == 'production':
            if self.swagger_enabled:
                raise ValueError('swagger_enabled must be False in production')
            if '*' in self.cors_origins:
                raise ValueError('CORS wildcard ["*"] not allowed in production')
        return self
```

**Verification:**
```bash
# JSON format
export CORS_ORIGINS='["https://yourdomain.com"]'
python -c "from app.core.config import settings; print(settings.cors_origins)"

# Comma-separated
export CORS_ORIGINS=https://yourdomain.com,https://api.yourdomain.com
python -c "from app.core.config import settings; print(settings.cors_origins)"

# Production validation
export ENVIRONMENT=production CORS_ORIGINS='["*"]'
python -c "from app.core.config import settings"
# Should raise ValueError
```

**Acceptance Criteria:**
- [ ] JSON array format works
- [ ] Comma-separated format works
- [ ] Production validation prevents `["*"]`
- [ ] Production validation prevents `swagger_enabled=True`
- [ ] Error messages are clear

---

## Testing & Verification

### Unit Tests
**File:** `tests/test_security.py` (add to existing security tests)

```python
def test_swagger_disabled_in_production():
    """Verify Swagger is disabled when SWAGGER_ENABLED=false"""
    os.environ['SWAGGER_ENABLED'] = 'false'
    os.environ['ENVIRONMENT'] = 'production'
    from app.core.config import Settings
    settings = Settings()
    assert settings.swagger_enabled == False

def test_cors_validation_rejects_wildcard_in_production():
    """Verify CORS wildcard is rejected in production"""
    os.environ['CORS_ORIGINS'] = '["*"]'
    os.environ['ENVIRONMENT'] = 'production'
    with pytest.raises(ValueError):
        from app.core.config import Settings
        Settings()

def test_cors_specific_origins():
    """Verify CORS accepts specific origins"""
    os.environ['CORS_ORIGINS'] = '["https://yourdomain.com"]'
    from app.core.config import Settings
    settings = Settings()
    assert settings.cors_origins == ["https://yourdomain.com"]
```

### Integration Tests
```python
@pytest.mark.asyncio
async def test_docs_disabled_in_production(client_prod):
    """Verify /docs returns 404 in production"""
    response = await client_prod.get("/docs")
    assert response.status_code == 404

@pytest.mark.asyncio
async def test_docs_enabled_in_development(client_dev):
    """Verify /docs returns 200 in development"""
    response = await client_dev.get("/docs")
    assert response.status_code == 200

@pytest.mark.asyncio
async def test_cors_allows_specific_origin(client):
    """Verify CORS header is set for allowed origins"""
    response = await client.options(
        "/api/v1/convert",
        headers={"Origin": "https://yourdomain.com"}
    )
    assert response.headers.get("Access-Control-Allow-Origin") == "https://yourdomain.com"

@pytest.mark.asyncio
async def test_cors_rejects_unauthorized_origin(client):
    """Verify CORS header is NOT set for unauthorized origins"""
    response = await client.options(
        "/api/v1/convert",
        headers={"Origin": "https://evil.com"}
    )
    assert "Access-Control-Allow-Origin" not in response.headers or response.headers.get("Access-Control-Allow-Origin") != "https://evil.com"
```

---

## Definition of Done

✅ All acceptance criteria met:
- [ ] Configuration supports `SWAGGER_ENABLED` and `CORS_ORIGINS` env vars
- [ ] Swagger disabled in production (returns 404 on `/docs`)
- [ ] CORS configured to specific origins (no wildcard in production)
- [ ] `.env.production` example file created and documented
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Manual verification commands work
- [ ] No breaking changes to existing functionality
- [ ] Code follows existing style and patterns
- [ ] Documentation updated (if needed)

---

## Files to Modify

1. **app/core/config.py**
   - Add `swagger_enabled` setting
   - Add JSON/CSV parsing for `cors_origins`
   - Add production validation

2. **app/main.py**
   - Conditionally disable Swagger docs

3. **tests/test_security.py**
   - Add security tests for Swagger and CORS

4. **.env.production** (NEW)
   - Example production configuration

---

## Success Criteria

After execution:
```bash
# Development mode (Swagger enabled)
curl http://localhost:8000/docs → 200 OK (HTML with Swagger UI)

# Production mode (Swagger disabled)
SWAGGER_ENABLED=false CORS_ORIGINS='["https://yourdomain.com"]' \
  python -m uvicorn app.main:app
curl http://localhost:8000/docs → 404 Not Found
curl http://localhost:8000/api/v1/convert -H "Origin: https://yourdomain.com" → includes CORS header
curl http://localhost:8000/api/v1/convert -H "Origin: https://evil.com" → no CORS header
```

---

## Next Steps After EXECUTE

1. Commit changes with message: "Task 5.1: Disable Swagger and configure CORS for production"
2. Run full test suite to verify no regressions
3. Proceed to ARCHIVE to move this PRD
4. Select Task 5.2 (Configure Monitoring & Alerting)

---
**Archived:** 2026-01-13
