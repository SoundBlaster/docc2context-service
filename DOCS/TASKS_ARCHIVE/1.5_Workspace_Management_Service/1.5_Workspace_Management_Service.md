# Task PRD: 1.5 â€” Workspace Management Service

**Version:** 1.0.0  
**Source:** Workplan.md Task 1.5  
**Priority:** Critical  
**Phase:** 1  
**Effort:** 3-4 hours  
**Dependencies:** Task 1.4  

## Objective

Create workspace isolation service with ephemeral directories using uuid4, workspace cleanup after request completion, and startup cleanup script for orphaned directories.

## Current State Analysis

Based on repository inspection:
- FastAPI application structure is complete from Task 1.3
- File upload and validation is implemented from Task 1.4
- Configuration management is available for workspace settings
- Logging and request ID tracking are implemented
- Need to implement temporary workspace management for file processing

## Implementation Plan

### Subtask 1.5.1: Create Workspace Isolation Service
**Files to touch:**
- `app/services/workspace_manager.py` (create workspace management service)
- `app/core/config.py` (add workspace configuration)
- `app/api/v1/endpoints.py` (integrate workspace management)

**Acceptance Criteria:**
- [x] Unique workspace directories are created per request using uuid4
- [x] Base path: `/tmp/swift-conv-{uuid}/`
- [x] Directory permissions are secure (700 or similar)
- [x] Workspace creation is logged with request ID

### Subtask 1.5.2: Implement Workspace Cleanup
**Files to touch:**
- `app/services/workspace_manager.py` (add cleanup functionality)
- `app/api/v1/endpoints.py` (integrate cleanup in request lifecycle)

**Acceptance Criteria:**
- [x] Workspaces are deleted after request completion (success or failure)
- [x] Cleanup uses try/finally or context manager pattern
- [x] Cleanup failures are logged but don't crash the application
- [x] All temporary files are removed from workspace

### Subtask 1.5.3: Create Startup Cleanup Script
**Files to touch:**
- `scripts/cleanup_workspaces.py` (create cleanup script)
- `Dockerfile` (add cleanup to entrypoint if needed)
- `app/core/config.py` (add cleanup configuration)

**Acceptance Criteria:**
- [x] Startup script clears orphaned `/tmp/swift-conv-*` directories
- [x] Script can be run as cron job or container entrypoint
- [x] Cleanup is logged appropriately
- [x] Script handles permission errors gracefully

### Subtask 1.5.4: Integrate with File Upload Endpoint
**Files to touch:**
- `app/api/v1/endpoints.py` (integrate workspace management)
- `app/services/file_validation.py` (update to use workspace)

**Acceptance Criteria:**
- [x] Uploaded files are stored in isolated workspace
- [x] Workspace is created before file processing
- [x] Workspace is cleaned up after response
- [x] File paths use workspace isolation

## Definition of Done

### Functional Requirements
- [x] Unique workspace directories are created per request
- [x] Workspaces are deleted after request completion
- [x] Startup script cleans orphaned directories
- [x] Directory permissions are secure (700 or similar)

### Technical Requirements
- [x] All workspace operations use secure methods
- [x] Error handling is comprehensive and logged
- [x] Memory usage is optimized for concurrent requests
- [x] Code follows FastAPI best practices

### API Integration
```
POST /api/v1/convert
Process:
1. Create workspace: /tmp/swift-conv-{uuid}/
2. Validate and store uploaded file in workspace
3. Process file (future task)
4. Return response
5. Cleanup workspace (always executed)
```

### Verification Commands
```bash
# Test workspace creation and cleanup
python -c "
from app.services.workspace_manager import WorkspaceManager
import asyncio

async def test():
    wm = WorkspaceManager()
    async with wm.create_workspace() as workspace:
        print(f'Workspace created: {workspace.path}')
        # Test file operations
    print('Workspace cleaned up')

asyncio.run(test())
"

# Test startup cleanup
python scripts/cleanup_workspaces.py

# Test with file upload
curl -X POST -F "file=@valid.zip" http://localhost:8000/api/v1/convert
# Check /tmp/swift-conv-* directories before and after
```

### Integration Points
- **Task 1.4**: File upload will store files in workspace
- **Task 1.6**: SubprocessManager will process files in workspace
- **Task 2.1**: Frontend will benefit from secure file handling

## Security Considerations

- **Workspace isolation**: Each request gets isolated directory
- **Secure permissions**: Workspace directories use 700 permissions
- **Automatic cleanup**: No residual files left on disk
- **Path validation**: All file operations stay within workspace

## Risk Mitigation

- **Orphaned workspaces**: Startup cleanup script handles crashed processes
- **Permission errors**: Graceful handling of filesystem issues
- **Disk space**: Regular cleanup prevents accumulation
- **Concurrent access**: UUID-based isolation prevents conflicts

---

**Archived:** 2026-01-10
