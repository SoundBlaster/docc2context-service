# Task PRD: 1.6 â€” SubprocessManager for Swift CLI Execution

**Version:** 1.0.0  
**Source:** Workplan.md Task 1.6  
**Priority:** Critical  
**Phase:** 1  
**Effort:** 4-6 hours  
**Dependencies:** Task 1.5  

## Objective

Create SubprocessManager class to handle Swift CLI execution with timeout, check=True to prevent hanging processes, and proper error handling for conversion operations.

## Current State Analysis

Based on repository inspection:
- FastAPI application structure is complete from Task 1.3
- File upload, validation, and workspace management are implemented from Tasks 1.4-1.5
- Configuration management is available for subprocess settings
- Logging and request ID tracking are implemented
- Need to implement subprocess management for Swift CLI execution
- Swift binary should be available from Task 1.2 (Docker environment setup)

## Implementation Plan

### Subtask 1.6.1: Create SubprocessManager Class
**Files to touch:**
- `app/services/subprocess_manager.py` (create subprocess management service)
- `app/core/config.py` (add subprocess configuration)

**Acceptance Criteria:**
- [ ] SubprocessManager class with execute_command method
- [ ] Configurable timeout support (default 60 seconds)
- [ ] check=True to prevent hanging processes
- [ ] Proper stdout/stderr capture and logging
- [ ] Command execution is logged with request ID

### Subtask 1.6.2: Implement Swift CLI Integration
**Files to touch:**
- `app/services/subprocess_manager.py` (add Swift CLI specific methods)
- `app/core/config.py` (add Swift CLI path configuration)

**Acceptance Criteria:**
- [ ] Swift CLI binary path is configurable
- [ ] Method to execute docc2context conversion
- [ ] Proper argument passing for input/output paths
- [ ] Error handling for CLI failures
- [ ] Support for different CLI commands (version, help, convert)

### Subtask 1.6.3: Add Error Handling and Validation
**Files to touch:**
- `app/services/subprocess_manager.py` (enhance error handling)
- `app/api/v1/endpoints.py` (integrate subprocess manager)

**Acceptance Criteria:**
- [ ] Timeout exceptions are caught and logged
- [ ] CLI exit codes are properly interpreted
- [ ] Detailed error messages from CLI stderr
- [ ] Graceful handling of missing Swift binary
- [ ] Validation of CLI availability on startup

### Subtask 1.6.4: Integrate with File Processing Pipeline
**Files to touch:**
- `app/api/v1/endpoints.py` (integrate subprocess manager)
- `app/services/subprocess_manager.py` (add conversion workflow)

**Acceptance Criteria:**
- [ ] File upload endpoint uses SubprocessManager
- [ ] ZIP files are extracted in workspace before conversion
- [ ] Swift CLI is executed with proper arguments
- [ ] Conversion results are prepared for response
- [ ] Full pipeline is tested end-to-end

## Definition of Done

### Functional Requirements
- [ ] SubprocessManager handles Swift CLI execution
- [ ] Timeout and hanging process prevention
- [ ] Proper error handling and logging
- [ ] Integration with file processing pipeline

### Technical Requirements
- [ ] All subprocess operations use secure methods
- [ ] Error handling is comprehensive and logged
- [ ] Memory usage is optimized for CLI output
- [ ] Code follows FastAPI best practices

### CLI Integration
```
Swift CLI Commands:
- docc2context --version: Check binary availability
- docc2context --help: Get usage information
- docc2context input.zip output.md: Convert archive to markdown

Process:
1. Extract ZIP file in workspace
2. Run Swift CLI conversion
3. Package results for response
4. Cleanup workspace
```

### Verification Commands
```bash
# Test subprocess manager directly
python -c "
from app.services.subprocess_manager import SubprocessManager
import asyncio

async def test():
    sm = SubprocessManager()
    result = await sm.execute_command(['echo', 'test'])
    print('Command result:', result)

asyncio.run(test())
"

# Test Swift CLI integration
python -c "
from app.services.subprocess_manager import SubprocessManager
import asyncio

async def test():
    sm = SubprocessManager()
    result = await sm.check_swift_binary()
    print('Swift binary check:', result)

asyncio.run(test())
"

# Test full pipeline
curl -X POST -F "file=@valid.zip" http://localhost:8000/api/v1/convert
```

### Integration Points
- **Task 1.5**: Workspace management provides isolated execution environment
- **Task 1.4**: File validation ensures safe input for CLI
- **Task 2.1**: Frontend will consume conversion results

## Security Considerations

- **Command injection**: Only allow predefined commands and arguments
- **Path validation**: Ensure all file paths stay within workspace
- **Resource limits**: Timeout prevents resource exhaustion
- **Output sanitization**: Handle potentially malicious CLI output

## Risk Mitigation

- **Missing binary**: Graceful degradation with clear error messages
- **CLI failures**: Detailed error reporting for debugging
- **Timeout issues**: Configurable timeouts for different operations
- **Memory usage**: Stream CLI output to avoid memory exhaustion
